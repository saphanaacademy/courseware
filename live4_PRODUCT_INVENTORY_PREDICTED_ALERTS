-- run this as LIVE4 user to create the PRODUCT_INVENTORY_PREDICTED_ALERTS view
-- this view finds the closest store that can transfer the required inventory for a particular product
-- this view would be run after running Predictive Analysis

DROP VIEW LIVE4.PRODUCT_INVENTORY_PREDICTED_ALERTS;

CREATE VIEW LIVE4.PRODUCT_INVENTORY_PREDICTED_ALERTS  AS 
SELECT * FROM
(
	SELECT 
	 WS.ROWNUM STR_NUM, WS.WERKS, WS.NAME1, WS.AQI, WS.TMP, WS. HUM, WS.STR_LONGITUDE, WS.STR_LATITUDE,
	 IA.MATNR, IA.MAKTX, IA.INVENTORY, IA.QUANTITY_PREDICTED, IA.INVENTORY_PREDICTED_SPARE,
	 WST.*,
	 NEW ST_Point(WS.STR_LONGITUDE, WS.STR_LATITUDE).ST_Distance(NEW ST_Point(WST.STR_LONGITUDE_T, WST.STR_LATITUDE_T)) AS DIST_CS,
	 ROW_NUMBER() over (PARTITION BY WS.WERKS, IA.MATNR ORDER BY NEW ST_Point(WS.STR_LONGITUDE, WS.STR_LATITUDE).ST_Distance(NEW ST_Point(WST.STR_LONGITUDE_T, WST.STR_LATITUDE_T)) ASC, IA.INVENTORY_PREDICTED_SPARE DESC) AS RANK
 	FROM 
	 LIVE4.LIVE4.T001W_WS WS
	LEFT JOIN
	 (
		SELECT
	 	 PI.WERKS,
	 	 PI.MATNR,
	 	 MA.MAKTX,
	 	 ROUND(PI.INVENTORY) AS INVENTORY,
	 	 ROUND(PF.FITTED) AS QUANTITY_PREDICTED,
	 	 (ROUND(PI.INVENTORY) - ROUND(PF.FITTED)) AS INVENTORY_PREDICTED_SPARE 
		FROM 
	 	 LIVE4.PRODUCT_INVENTORY PI 
		INNER JOIN LIVE4.MAKT MA ON (MA.MATNR = PI.MATNR) 
		INNER JOIN LIVE4.PAL_P_DATA PD ON (PD.WERKS = PI.WERKS 
	 	 AND PD.MATNR = PI.MATNR) 
		INNER JOIN LIVE4.PAL_FITTED PF ON (PF.ID = PD.ID)
		WHERE
	 	 (ROUND(PI.INVENTORY) - ROUND(PF.FITTED)) < 0
	 ) IA
	ON WS.WERKS = IA.WERKS
	INNER JOIN
	 (
		SELECT
		 WS.ROWNUM AS STR_NUM_T, 
		 WS.WERKS AS WERKS_T,
		 WS.NAME1 AS NAME1_T,
	 	 WS.STR_LONGITUDE AS STR_LONGITUDE_T,
	 	 WS.STR_LATITUDE AS STR_LATITUDE_T,
	 	 IR.MATNR AS MATNR_T,
	 	 IR.MAKTX AS MAKTX_T,
	 	 IR.INVENTORY_PREDICTED_SPARE AS INVENTORY_PREDICTED_SPARE_T 
 		FROM 
	 	 LIVE4.T001W_WS WS	
		INNER JOIN
	 	 (
			SELECT
	 	 	 PI.WERKS,
	 	 	 PI.MATNR,
	 	 	 MA.MAKTX,
	 	 	 ROUND(PI.INVENTORY) AS INVENTORY,
	 	 	 ROUND(PF.FITTED) AS QUANTITY_PREDICTED,
	 	 	 (ROUND(PI.INVENTORY) - ROUND(PF.FITTED)) AS INVENTORY_PREDICTED_SPARE 
			FROM 
	 	 	 LIVE4.PRODUCT_INVENTORY PI 
			INNER JOIN LIVE4.MAKT MA ON (MA.MATNR = PI.MATNR) 
			INNER JOIN LIVE4.PAL_P_DATA PD ON (PD.WERKS = PI.WERKS 
	 	 	 AND PD.MATNR = PI.MATNR) 
			INNER JOIN LIVE4.PAL_FITTED PF ON (PF.ID = PD.ID)
			WHERE
	 	 	 (ROUND(PI.INVENTORY) - ROUND(PF.FITTED)) > 0
	 	 ) IR
		ON WS.WERKS = IR.WERKS
	 )	 WST
	ON IA.MATNR = WST.MATNR_T
	WHERE
	 IA.INVENTORY_PREDICTED_SPARE + WST.INVENTORY_PREDICTED_SPARE_T > 0
	ORDER BY WS.WERKS ASC, IA.MATNR ASC, ROWNUM DESC 
) FR
WHERE FR.RANK = 1
ORDER BY FR.NAME1, FR.INVENTORY_PREDICTED_SPARE, FR.MAKTX ASC;

SELECT * FROM LIVE4.PRODUCT_INVENTORY_PREDICTED_ALERTS
